import{v as o,O as G,u as Y,l as E,i as Q,A as T,I as K,Q as tt,d as et,M as st,D as at,a as nt,b as it,c as ot,e as rt,B as _,y as b,f as lt,o as N,g as z,s as ct,h as dt,j as f,r as ht,k as mt,Z as L,P as gt,m as D,n as ut,p as pt,T as ft,q as yt,t as j,w as B,x as bt,z as J,C as I,E as v,F as wt,G as xt,U as Et,L as St,S as Mt,H as Tt,J as _t,K as P,N as At,R as Dt,V as It,W as vt,X as Ct,Y as Ot,_ as kt,$ as Ht,a0 as F,a1 as Nt,a2 as $,a3 as W,a4 as zt,a5 as Lt,a6 as jt}from"./vendor.314a901a.js";const Bt=[{name:"nocache",displayName:"Disable caching",type:"boolean",default:!1},{name:"hide_auto_help",displayName:"Hide automatic help",type:"boolean",default:!1}],Jt=()=>o(G,{options:Bt}),Pt=({url:a})=>{const[t]=Y("options"),e=t&&t.hide_auto_help,[n,s]=E(Q()?!1:!e),i=T(()=>{s(!n)},[n]);return a=a||`${window.location.origin}${window.location.pathname}README.md`,o(et,null,o(K,{verticalAlign:"top","aria-label":"Help",icon:o(tt,null),size:"lg",onClick:i,mr:"4"}),o(Ft,{url:a,isOpen:n,setOpen:s}))},Ft=({isOpen:a,setOpen:t,url:e})=>{const n=T(()=>{t(!a)},[t,a]),s=T(()=>{t(!1)},[t]),i=`https://metapages.github.io/metaframe-markdown/#?url=${e}`;return o(ot,{size:"full",placement:"top",onClose:n,isOpen:a,onOverlayClick:s},o(st,null,o(at,null,o(nt,{size:"lg",colorScheme:"blue.500",bg:"gray.100"}),o(it,null,o("iframe",{width:"100%",height:"100%",src:i})))))},p=rt(a=>({messages:[],modelCount:-1,model:void 0,trainingDataSet:void 0,predictionInput:void 0,predictionOutput:void 0,currentlyTrainingDataHash:null,clearMessages:()=>a(t=>({messages:[]})),addMessage:t=>a(e=>({messages:e.messages.concat([t])})),setMessages:t=>a(e=>({messages:t})),setTrainingDataSet:t=>a(e=>({trainingDataSet:t})),updateModels:async()=>{const t=await $t();a(e=>({modelCount:t}))},deleteModels:async()=>{await Wt(),a(t=>({modelCount:0}))},setModel:async t=>{a(e=>({model:t}))},setPredictionInput:async t=>{a(e=>({predictionInput:t}))},setPredictionOutput:async t=>{a(e=>({predictionOutput:t}))}})),$t=async()=>{const a=await _.listModels();return Object.keys(a).length},Wt=async()=>{const a=await _.listModels(),t=Object.keys(a).map(e=>_.removeModel(e));try{await Promise.all(t)}catch(e){console.error(e)}},Ut=()=>{const a=p(s=>s.modelCount),t=p(s=>s.updateModels),e=p(s=>s.deleteModels),n=T(async()=>{e()},[e]);return b(()=>{(async()=>{await t()})()},[t]),o(lt,{isDisabled:a<=0,onClick:n},"Clear cache (",a>0?a:0," models)")},U=a=>{const t={};return Object.keys(a).forEach(e=>t[e]=new Float32Array(C(a[e]))),t},Vt=a=>({requestId:a.requestId,series:U(a.series)}),S="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",M=new Uint8Array(256);for(var A=0;A<S.length;A++)M[S.charCodeAt(A)]=A;function V(a){let t=new Uint8Array(a),e,n=t.length,s="";for(e=0;e<n;e+=3)s+=S[t[e]>>2],s+=S[(t[e]&3)<<4|t[e+1]>>4],s+=S[(t[e+1]&15)<<2|t[e+2]>>6],s+=S[t[e+2]&63];return n%3==2?s=s.substring(0,s.length-1)+"=":n%3==1&&(s=s.substring(0,s.length-2)+"=="),s}function C(a){if(!a)throw new Error("base64decode string argument given");let t=a.length*.75,e=a.length,n,s=0,i,r,l,c;a[a.length-1]==="="&&(t--,a[a.length-2]==="="&&t--);var h=new ArrayBuffer(t),d=new Uint8Array(h);for(n=0;n<e;n+=4)i=M[a.charCodeAt(n)],r=M[a.charCodeAt(n+1)],l=M[a.charCodeAt(n+2)],c=M[a.charCodeAt(n+3)],d[s++]=i<<2|r>>4,d[s++]=(r&15)<<4|l>>2,d[s++]=(l&3)<<6|c&63;return h}/**
 * @license
 * Private wand license.
 * Currently very specific to gestures, need to loosen that up
 */const qt=.7;class Xt{constructor(t){this.data={},this.ranges={},this._labels=[],this._streams=[],this.shuffledTrainIndex=0,this.shuffledTestIndex=0,this.trainingIndices=new Uint32Array,this.testingIndices=new Uint32Array,this.bigFatDataArray=new Float32Array,this.bigFatLabelArray=new Uint8Array,this._timesteps=0,this.trainingDataJson=t}hash(){if(!this.trainingDataJson)throw"No trainingDataJson to hash";return N(this.trainingDataJson)}nextTrainBatch(t){return this.nextBatch(t,this.trainingIndices)}nextTestBatch(t){return this.nextBatch(t,this.testingIndices)}nextBatch(t,e){const n=new Float32Array(t*this.imageSize),s=new Uint8Array(t*this.numClasses);console.assert(this.numClasses>0);for(let l=0;l<t;l++){const c=e[l%e.length],h=c*this.imageSize,d=this.bigFatDataArray.slice(h,h+this.imageSize);n.set(d,l*this.imageSize);const g=c*this.numClasses,m=this.bigFatLabelArray.slice(g,g+this.numClasses);s.set(m,l*this.numClasses)}const i=z(n,[t,this.imageSize]),r=z(s,[t,this.numClasses]);return{xs:i,labels:r}}get classNames(){return this._labels}get gestureNames(){return this.classNames}get numClasses(){return this._labels.length}get imageWidth(){return this._streams.length}get width(){return this.imageWidth}get imageHeight(){return this.timeSteps}get height(){return this.imageHeight}get imageSize(){return this.imageWidth*this.imageHeight}get timeSteps(){return this._timesteps}get trainingExampleCount(){return this.trainingIndices.length}get testingExampleCount(){return this.testingIndices.length}allNonTimeValues(t){this.allNonTimeSensorStreams((e,n,s,i)=>{e.forEach((r,l)=>{t(r,l,e,n,s,i)})})}allSensorStreams(t){Object.keys(this.data).forEach(e=>{this.data[e].forEach((s,i)=>{const r=s.data;this._streams.forEach(l=>{t(r[l],l,i,e)})})})}allNonTimeSensorStreams(t){Object.keys(this.data).forEach(e=>{this.data[e].forEach((s,i)=>{const r=s.data;this._streams.forEach(l=>{l.endsWith("t")||t(r[l],l,i,e)})})})}allExamples(t){Object.keys(this.data).forEach(e=>{this.data[e].forEach((s,i)=>{const r=s.data;t(r,i,e)})})}getMaxValue(){let t=0;const e=n=>{t=Math.max(Math.abs(n),t)};return this.allNonTimeValues(e),t}normalize(){console.log("    normalizing...");const t=this._streams.filter(e=>!e.endsWith("t"));t.forEach(e=>this.ranges[e]={min:Number.MAX_VALUE,max:Number.MIN_VALUE,absmax:Number.MIN_VALUE}),this.allNonTimeSensorStreams((e,n,s,i)=>{e.forEach(r=>{this.ranges[n].min=Math.min(this.ranges[n].min,r),this.ranges[n].max=Math.max(this.ranges[n].max,r)})}),t.forEach(e=>this.ranges[e].absmax=Math.max(this.ranges[e].max,Math.abs(this.ranges[e].min))),this.allNonTimeSensorStreams((e,n,s,i)=>{const r=this.ranges[n].absmax;e.forEach((l,c)=>{e[c]=e[c]/r})}),console.log(`        this.ranges=${JSON.stringify(this.ranges)}`)}zeroTime(){console.log("    zeroing time..."),this.allExamples(t=>{const e=this._streams.filter(s=>s.endsWith("t"));let n=Number.MAX_VALUE;e.forEach(s=>{t[s].forEach((i,r)=>n=Math.min(n,i))}),e.forEach(s=>{t[s].forEach((i,r)=>{t[s][r]=i-n})})})}trimToLongestNonZeroGesture(){console.log("    getting longest non-default gesture...");let t=0,e=0;const n=this._streams.filter(s=>!s.endsWith("t"));this.allExamples((s,i,r)=>{if(!this.trainingDataJson.controlLabels||!this.trainingDataJson.controlLabels.includes(r)){let l=s[this._streams[0]].length-1;for(;l>=0&&!(n.filter(c=>s[c][l]!=0).length>0);l--);t=Math.max(t,l+1)}e=Math.max(e,s[this._streams[0]].length)}),console.log(`        [max=${t}] [maxAll=${e}]...trimming...`),this.allExamples((s,i,r)=>{this._streams.forEach(l=>{s[l]=s[l].slice(0,t)})}),e=0,this.allSensorStreams(s=>{e=Math.max(e,s.length)}),console.log(`        all arrays now [max=${e}]`)}extend(){console.log("    extending...");let t=0;const e=[];this.allSensorStreams(n=>{t=Math.max(t,n.length),n.forEach((s,i)=>{i!=0&&e.push(s-n[i-1])})}),this._timesteps=t,console.log(`        this.timeSteps=${this.timeSteps}`)}processPrediction(t){if(!t)throw"processExample: missing example";if(this._timesteps===0)throw"processPrediction but this._timesteps === 0";Object.keys(t).forEach(s=>{if(t[s].length>this._timesteps&&(t[s]=t[s].slice(0,this._timesteps)),t[s].length<this._timesteps){const i=new Float32Array(this._timesteps);i.set(t[s]),t[s]=i}}),Object.keys(t).forEach(s=>{const i=this.ranges[s].absmax;t[s].forEach((r,l,c)=>{c[l]=r/i})});const e=new Float32Array(1*this.imageSize);let n=0;return this._streams.forEach(s=>{const i=n*this.timeSteps;e.set(t[s],i),n++}),e}async load(){console.log(`Begin loading examples from ${this.trainingDataJson.examples.length} gestures and converting to float arrays...`),this.data={};const t=this.data;this._streams=[];const e={};this.trainingDataJson.examples.forEach(c=>{const h=c.label;t[h]||(t[h]=[]);const d=U(c.data.series);Object.keys(d).forEach(m=>e[m]=!0);const g={data:d,url:c.name||c.url};t[h].push(g)}),this._streams=Object.keys(e),this._streams.sort(),this._labels=Object.keys(this.data),this._labels.sort(),console.log(`labels: [  ${this._labels.join("  |  ")}  ]`),console.log("    done loading raw gesture data, begin preprocessing..."),this.trimToLongestNonZeroGesture(),this.normalize();const n=this.getMaxValue();if(console.log(`        normalizedMax=${n}`),n!=1)throw"Failed to normalize";this.zeroTime(),this.extend(),console.log("    converting to large combined float arrays...");const s=Object.keys(this.data).reduce((c,h)=>c+this.data[h].length,0);this.bigFatDataArray=new Float32Array(s*this.imageSize),this.bigFatLabelArray=new Uint8Array(s*this.numClasses),console.log(`        totalExampleCount=${s} imageSize=${this.imageSize} numClasses=${this.numClasses}`),console.log(`            width=${this.width} height=${this.height}`);let i=0;this.classNames.forEach((c,h)=>{this.data[c].forEach(g=>{this.bigFatLabelArray[i*this.numClasses+h]=1;const m=g.data;let y=0;this._streams.forEach(u=>{const O=i*this.imageSize+y*this.timeSteps;this.bigFatDataArray.set(m[u],O),y++}),i++})});const r=ct.createShuffledIndices(s),l=Math.floor(qt*s);this.trainingIndices=r.slice(0,l),this.testingIndices=r.slice(l)}}/**
 * @license
 * Private wand license.
 */const Zt=32,Rt=10;class Gt{constructor(t){this.classNames=[],this._data=t,this.createModel()}get model(){return this._model}createModel(){const t=this._data;this.classNames=t.classNames,this._model=dt(),this._model.add(f.conv1d({filters:100,kernelSize:7,strides:1,activation:"relu",kernelInitializer:"varianceScaling",inputShape:[t.height,t.width]})),this._model.add(f.conv1d({filters:100,kernelSize:7,strides:1,activation:"relu"})),this._model.add(f.conv1d({filters:100,kernelSize:7,strides:1,activation:"relu"})),this._model.add(f.maxPooling1d({poolSize:3})),this._model.add(f.conv1d({filters:100,kernelSize:7,strides:1,activation:"relu"})),this._model.add(f.globalAveragePooling1d()),this._model.add(f.dropout({rate:.5})),f.flatten(),this._model.add(f.dense({units:t.classNames.length,activation:"softmax"})),this._model.summary();const e=ht.adam();return this._model.compile({optimizer:e,loss:"categoricalCrossentropy",metrics:["accuracy"]}),this._model}async train(){const t=this._data,e=["loss","val_loss","acc","val_acc"],n=document.getElementById("Training"),s=mt.show.fitCallbacks(n,e),i=t.trainingExampleCount*2,[r,l]=L(()=>{const m=t.nextTrainBatch(i);return[m.xs.reshape([i,t.imageHeight,t.imageWidth]),m.labels]}),c=t.testingExampleCount*2,[h,d]=L(()=>{const m=t.nextTestBatch(c);return[m.xs.reshape([c,t.imageHeight,t.imageWidth]),m.labels]}),g=await this.model.fit(r,l,{batchSize:Zt,validationData:[h,d],epochs:Rt,shuffle:!0,callbacks:s});return this.model,g}}const q=async a=>{const t=new Yt;await a.model.save(t);const e=Object.assign({},a);return e.model=t.modelJson,e};class Yt{constructor(t){this.modelJson=t}async save(t){const e={modelArtifactsInfo:{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:t.modelTopology.byteLength,weightDataBytes:t.weightData.byteLength}};try{return this.modelJson=Object.assign({},t),this.modelJson.modelTopology=V(t.modelTopology),this.modelJson.weightData=V(t.weightData),e}catch(n){return e.errors=["{err}"],e}}async load(){console.log("JsonIOHandler.loading");const t=Object.assign({},this.modelJson);return t.modelTopology=C(this.modelJson.modelTopology),t.weightData=C(this.modelJson.weightData),console.log("JsonIOHandler.modelArtifacts",t),t}}const Qt=async(a,t)=>{if(!a)return[void 0,new Error("Asked to predict sample but no model loaded")];if(!t)return[void 0,new Error("Asked to predict but no input")];if(!t.series)return[void 0,new Error("Asked to predict but input lacks 'series' field")];const e=t.series,n=Kt(a,e),s=gt(n,[1,a.meta.prediction.imageHeight,a.meta.prediction.imageWidth]),i=a.model.predictOnBatch(s).dataSync();let r=0,l="",c;const h={};return a.meta.prediction.classNames.forEach((g,m)=>{h[g]=i[m],i[m]>r&&(r=i[m],l=g)}),l!=="_"&&h[l]<.45&&h._&&(c=`${l} -> _ because score < 0.45`,l="_"),[{prediction:l,predictions:h,requestId:t.requestId,modelHash:a.meta.training.hash,note:c},void 0]},Kt=(a,t)=>{if(!t)throw"processExample: missing example";if(!a)throw"processExample: missing model";Object.keys(t).forEach(i=>{i.endsWith("t")&&delete t[i]});const e=Object.keys(t);e.sort();const n=Math.max(a.meta.prediction.imageHeight,a.meta.prediction.imageWidth);e.forEach(i=>{if(t?.[i]?.length>n&&(t[i]=t[i].slice(0,n)),t?.[i]?.length<n){const r=new Float32Array(n);r.set(t[i]),t[i]=r}}),e.forEach(i=>{t[i].forEach((r,l,c)=>{c[l]=r/a.meta.training.ranges[i].absmax})});const s=new Float32Array(1*a.meta.prediction.imageWidth*a.meta.prediction.imageHeight);return e.forEach((i,r)=>{const l=r*n;s.set(t[i],l)}),s},te=()=>{const a=D(),[t]=ut("nocache"),[e,n]=E(void 0),[s,i]=E(""),r=p(d=>d.setModel),l=p(d=>d.model);b(()=>{},[n]),b(()=>{const d=a?.inputs.training;if(d&&d!==n){const g=N(d);g!==s&&(i(g),n(d))}},[a.inputs,s,i,n]);const c=p(d=>d.updateModels),h=p(d=>d.setMessages);return b(()=>{if(!e||!e.examples||e.examples.length===0||!a?.setOutputs)return;const d={message:"Training",type:"info"},g=Object.keys(e.examples.reduce((y,u)=>(y[u.label]=!0,y),{}));if(g.length<2){const y={message:`Not enough data labels: [${g.join(", ")}]`,type:"warning"};h([d,y]);return}let m=!1;return(async()=>{h([d,{message:"loading data...",type:"info"}]);const u=new Xt(e);if(await u.load(),m)return;h([d,{message:"\u2705 loaded data",type:"info"}]);const w=u.hash(),k={prediction:{classNames:u.classNames,imageHeight:u.imageHeight,imageWidth:u.imageWidth},training:{date:new Date,hash:w,ranges:u.ranges}};let x;if(!t){const Z=await _.listModels();if(m)return;if(Z[`indexeddb://${w}`]){const R=await pt(`indexeddb://${w}`);if(m)return;x={model:R,meta:k},h([d,{message:`Model ready (cached) ${w.substr(0,10)}`,type:"success"}]),r(x);return}}h([d,{message:"training...",type:"warning"}]);const H=new Gt(u);if(await H.train(),m)return;h([d,{message:"\u2705 Trained",type:"warning"}]),x={model:H.model,meta:k},t||(await x.model.save(`indexeddb://${w}`),c()),r(x);const X=await q(x);a.setOutputs({model:X}),h([d,{message:`\u2705 Model ready ${w.substr(0,10)}`,type:"success"}])})(),()=>{m=!0}},[e,t,r,a?.setOutputs]),b(()=>{l&&a?.setOutputs&&(async()=>{const d=await q(l);a.setOutputs({model:d})})()},[l,a?.setOutputs]),o("div",null,o(Ut,null),o("div",{id:"Training"}))},ee=()=>{const a=D(),t=p(c=>c.model),[e,n]=E(void 0),[s,i]=E(void 0),[r,l]=E(void 0);return b(()=>{const c=a?.inputs?.prediction;if(c&&c!==e){n(c);const h=Vt(c);i(h)}},[a.inputs,e,n,i]),b(()=>{!s||!t||!a?.setOutputs||(async()=>{const[c,h]=await Qt(t,s);a.setOutputs({prediction:c,error:h?.message}),l(c)})()},[s,t,l,a.setOutputs]),o("div",null,o(I,{status:r?.prediction?"success":"info"},o(v,null),r?r.prediction:"...waiting for data"),r?.note?o(I,{status:"warning"},o(v,null),r?.note):null,o(ft,{variant:"simple"},o(yt,null,o(j,null,o(B,null,"Label"),o(B,null,"Score"))),o(bt,null,r?Object.keys(r.predictions).sort(c=>r.predictions[c]).map(c=>o(j,null,o(J,null,c),o(J,{isNumeric:!0},r.predictions[c]))):null)))},se=()=>{const a=p(t=>t.messages);return o(Mt,{spacing:3},a.map((t,e)=>o(I,{key:e,status:t.type?t.type:"info"},o(wt,{mr:2},t.message),o(v,null),o(xt,null,o(Et,null,t.messages?t.messages.map((n,s)=>o(St,{key:s},n)):null)))))},ae=()=>{const a=Tt(["red.50","teal.50","blue.50"],["red.900","teal.900","blue.900"]),[t,e]=_t("tab",0),n=a[t];return o(Ct,{columns:1,spacing:10},o(P,null,o(At,{size:"md"},o(Dt,{href:"https://www.tensorflow.org/js",isExternal:!0,mr:"2"},o(It,null)," Tensorflow 1D"),"convolutional neural net trainer/predictor"),o(vt,null),o(Pt,null),o(Jt,null)),o(P,null,o(se,null)),o(Ot,null,o(kt,{isFitted:!0,onChange:e,bg:n},o(Ht,null,o(F,null,"Train"),o(F,null,"Predict")),o(Nt,{p:"1rem"},o($,null,o(te,null)),o($,null,o(ee,null))))))},ne=()=>o("div",null,o(ae,null)),ie=()=>{const a=D(),t=p(n=>n.setTrainingDataSet),e=p(n=>n.setPredictionInput);return b(()=>{if(!a.metaframe)return;const n=[];return n.push(a.metaframe.onInput("training",s=>{s&&t(s)})),n.push(a.metaframe.onInput("prediction",s=>{s&&e(s)})),()=>{for(;n.length>0;)n.pop()()}},[a.metaframe,t]),o(ne,null)};W.config({driver:W.INDEXEDDB,name:"metaframe-predictor",version:1,storeName:"models",description:"Stores tensorflow models locally"}),zt(o(jt,null,o(Lt,null,o(ie,null))),document.getElementById("root"));
//# sourceMappingURL=index.0be8d545.js.map
